<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>🔐 Secure Vault</title>
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- ✅ iOS PWA support -->
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
  <meta name="apple-mobile-web-app-title" content="Secure Vault" />
  <link rel="apple-touch-icon" href="icon-512.png" />
  <link rel="manifest" href="manifest.json" />

  <style>
    body {
      background-color: #f9fafb;
      font-family: system-ui, sans-serif;
    }
  </style>
</head>
<body class="min-h-screen flex items-center justify-center p-4">

  <!-- 📱 iOS install prompt -->
  <div id="iosPrompt" class="fixed bottom-2 left-2 right-2 bg-blue-600 text-white text-center p-2 rounded-xl hidden">
    <p>📱 Tap <strong>Share</strong> → <strong>Add to Home Screen</strong> to install Secure Vault.</p>
  </div>

  <!-- 🧱 Main App Container -->
  <div id="app" class="w-full max-w-md bg-white shadow-xl rounded-2xl p-4">
    <h1 class="text-2xl font-bold text-center mb-3">🔐 Secure Vault</h1>

    <!-- Setup password -->
    <div id="passwordSetup" class="space-y-2">
      <input id="password" type="password" placeholder="Set Password" class="w-full border p-2 rounded" />
      <input id="hint" type="text" placeholder="Password Hint (optional)" class="w-full border p-2 rounded" />
      <button id="setPassword" class="bg-blue-600 text-white w-full p-2 rounded">Set Password</button>
    </div>

    <!-- Unlock Vault -->
    <div id="unlockVault" class="space-y-2 hidden">
      <input id="unlockPassword" type="password" placeholder="Enter Password" class="w-full border p-2 rounded" />
      <button id="unlockButton" class="bg-green-600 text-white w-full p-2 rounded">Unlock Vault</button>
      <p id="passwordHint" class="text-sm text-gray-500 mt-2"></p>
    </div>

    <!-- Vault Section -->
    <div id="vaultSection" class="hidden space-y-2 mt-4">
      <select id="entryType" class="border rounded w-full p-2">
        <option value="note">📝 Note</option>
        <option value="password">🔑 Password</option>
        <option value="reminder">💰 Payment Reminder</option>
      </select>

      <input id="entryTitle" placeholder="Title" class="border rounded w-full p-2" />
      <textarea id="entryContent" placeholder="Content" class="border rounded w-full p-2"></textarea>
      <input id="entryReminder" type="datetime-local" class="border rounded w-full p-2" />
      <input id="entryTags" placeholder="Tags (comma-separated)" class="border rounded w-full p-2" />
      <select id="entryRecurrence" class="border rounded w-full p-2">
        <option value="none">No recurrence</option>
        <option value="daily">Daily</option>
        <option value="weekly">Weekly</option>
        <option value="monthly">Monthly</option>
      </select>

      <button id="addEntry" class="bg-blue-500 text-white w-full p-2 rounded">Add Entry</button>
      <button id="exportVault" class="bg-green-600 text-white w-full p-2 rounded">Export Encrypted Backup</button>
      <button id="importVault" class="bg-yellow-600 text-white w-full p-2 rounded">Import Encrypted Backup</button>
      <button id="lockVault" class="bg-gray-600 text-white w-full p-2 rounded">Lock Vault</button>

      <ul id="entryList" class="mt-4 space-y-2"></ul>
    </div>
  </div>

  <script>
  /* ---------- Encryption ---------- */
  async function getKey(password, salt) {
    const keyMaterial = await crypto.subtle.importKey("raw", new TextEncoder().encode(password), "PBKDF2", false, ["deriveKey"]);
    return crypto.subtle.deriveKey(
      { name: "PBKDF2", salt, iterations: 150000, hash: "SHA-256" },
      keyMaterial,
      { name: "AES-GCM", length: 256 },
      false,
      ["encrypt", "decrypt"]
    );
  }

  async function encryptData(data, password) {
    const salt = crypto.getRandomValues(new Uint8Array(16));
    const iv = crypto.getRandomValues(new Uint8Array(12));
    const key = await getKey(password, salt);
    const encoded = new TextEncoder().encode(JSON.stringify(data));
    const cipher = await crypto.subtle.encrypt({ name: "AES-GCM", iv }, key, encoded);
    return { salt: Array.from(salt), iv: Array.from(iv), cipher: Array.from(new Uint8Array(cipher)) };
  }

  async function decryptData(obj, password) {
    try {
      const salt = new Uint8Array(obj.salt);
      const iv = new Uint8Array(obj.iv);
      const key = await getKey(password, salt);
      const data = await crypto.subtle.decrypt({ name: "AES-GCM", iv }, key, new Uint8Array(obj.cipher));
      return JSON.parse(new TextDecoder().decode(data));
    } catch {
      return null;
    }
  }

  /* ---------- App Logic ---------- */
  let vaultData = [];
  let masterPassword = null;

  const setup = document.getElementById("passwordSetup");
  const unlock = document.getElementById("unlockVault");
  const vault = document.getElementById("vaultSection");
  const hint = document.getElementById("hint");
  const hintText = document.getElementById("passwordHint");

  if (localStorage.getItem("vault")) {
    setup.classList.add("hidden");
    unlock.classList.remove("hidden");
    const savedHint = localStorage.getItem("vaultHint");
    if (savedHint) hintText.textContent = "💡 Hint: " + savedHint;
  }

  document.getElementById("setPassword").onclick = async () => {
    const password = document.getElementById("password").value;
    const hintValue = hint.value;
    if (!password.match(/^(?=.*[a-zA-Z])(?=.*[0-9])(?=.*[!@#$%^&*]).{8,}$/)) {
      alert("Password must have letters, numbers, symbols, and be 8+ chars long.");
      return;
    }
    masterPassword = password;
    localStorage.setItem("vaultHint", hintValue);
    localStorage.setItem("vault", JSON.stringify(await encryptData([], password)));
    setup.classList.add("hidden");
    unlock.classList.remove("hidden");
    alert("Password set successfully!");
  };

  document.getElementById("unlockButton").onclick = async () => {
    const password = document.getElementById("unlockPassword").value;
    const enc = JSON.parse(localStorage.getItem("vault"));
    const data = await decryptData(enc, password);
    if (!data) return alert("Incorrect password or vault corrupted.");
    masterPassword = password;
    vaultData = data;
    unlock.classList.add("hidden");
    vault.classList.remove("hidden");
    renderVault();
  };

  document.getElementById("lockVault").onclick = async () => {
    const enc = await encryptData(vaultData, masterPassword);
    localStorage.setItem("vault", JSON.stringify(enc));
    masterPassword = null;
    vault.classList.add("hidden");
    unlock.classList.remove("hidden");
  };

  /* ---------- Entry Management ---------- */
  document.getElementById("addEntry").onclick = () => {
    const type = entryType.value;
    const title = entryTitle.value.trim();
    const content = entryContent.value.trim();
    const reminder = entryReminder.value ? new Date(entryReminder.value).getTime() : null;
    const tags = entryTags.value.split(",").map(t => t.trim()).filter(t => t);
    const recurrence = entryRecurrence.value;
    if (!title || !content) return alert("Please fill title and content.");
    vaultData.unshift({ type, title, content, reminder, tags, recurrence });
    renderVault();
    entryTitle.value = entryContent.value = entryReminder.value = entryTags.value = "";
  };

  function renderVault() {
    const list = document.getElementById("entryList");
    list.innerHTML = "";
    vaultData.forEach((entry, i) => {
      const li = document.createElement("li");
      li.className = "p-3 border rounded-lg bg-gray-50";
      li.innerHTML = `<strong>${entry.type.toUpperCase()}</strong> – ${entry.title}<br>${entry.content}<br>
        ${entry.reminder ? "⏰ " + new Date(entry.reminder).toLocaleString() : ""}
        ${entry.recurrence !== "none" ? `<br>🔁 ${entry.recurrence}` : ""}
        <br><button onclick="deleteEntry(${i})" class="text-red-500">Delete</button>`;
      list.appendChild(li);
      scheduleNotification(entry);
    });
  }

  function deleteEntry(i) {
    vaultData.splice(i, 1);
    renderVault();
  }

  /* ---------- Notifications ---------- */
  async function scheduleNotification(entry) {
    if (!entry.reminder) return;
    const now = Date.now();
    let delay = entry.reminder - now;
    if (delay < 0) return;
    if (Notification.permission !== "granted") await Notification.requestPermission();
    setTimeout(() => {
      new Notification("🔔 Vault Reminder", { body: `${entry.title}: ${entry.content}` });
    }, delay);
  }

  /* ---------- Export / Import ---------- */
  document.getElementById("exportVault").onclick = async () => {
    if (!masterPassword) return;
    const enc = await encryptData(vaultData, masterPassword);
    const blob = new Blob([JSON.stringify(enc)], { type: "application/json" });
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url;
    a.download = "vault_backup.json";
    a.click();
    URL.revokeObjectURL(url);
  };

  document.getElementById("importVault").onclick = () => {
    const input = document.createElement("input");
    input.type = "file";
    input.accept = "application/json";
    input.onchange = async e => {
      const file = e.target.files[0];
      const text = await file.text();
      const obj = JSON.parse(text);
      const decrypted = await decryptData(obj, masterPassword);
      if (!decrypted) return alert("Failed to decrypt. Wrong password?");
      vaultData = decrypted;
      renderVault();
      alert("Vault imported successfully.");
    };
    input.click();
  };

  /* ---------- iOS PWA Prompt ---------- */
  if (/iphone|ipad|ipod/i.test(navigator.userAgent) && !window.navigator.standalone) {
    document.getElementById("iosPrompt").classList.remove("hidden");
  }
  </script>
</body>
</html>
