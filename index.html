<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>üîê Secure Vault</title>
<script src="https://cdn.tailwindcss.com"></script>

<!-- Firebase SDKs -->
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-messaging-compat.js"></script>
</head>

<body class="bg-gray-50 text-gray-900">
<div class="p-4 max-w-xl mx-auto" id="app">
  <h1 class="text-2xl font-bold mb-4">üîê Secure Vault</h1>
  <div id="vault-interface"></div>
</div>

<script>
// ---------------- FIREBASE CONFIG ----------------
const firebaseConfig = {
  apiKey: "YOUR_API_KEY",
  authDomain: "YOUR_PROJECT.firebaseapp.com",
  projectId: "YOUR_PROJECT",
  storageBucket: "YOUR_PROJECT.appspot.com",
  messagingSenderId: "YOUR_SENDER_ID",
  appId: "YOUR_APP_ID"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();
const messaging = firebase.messaging();

// ---------------- ENCRYPTION HELPERS ----------------
function bufToBase64(buf){return btoa(String.fromCharCode(...new Uint8Array(buf)))}
function base64ToBuf(b64){return Uint8Array.from(atob(b64), c=>c.charCodeAt(0))}
async function deriveKey(password, salt){
  const enc = new TextEncoder();
  const keyMaterial = await crypto.subtle.importKey('raw', enc.encode(password), 'PBKDF2', false, ['deriveKey']);
  return crypto.subtle.deriveKey({name:'PBKDF2',salt,iterations:200000,hash:'SHA-256'}, keyMaterial,{name:'AES-GCM',length:256},false,['encrypt','decrypt']);
}
async function encryptData(key,obj){
  const iv = crypto.getRandomValues(new Uint8Array(12));
  const enc = new TextEncoder();
  const ct = await crypto.subtle.encrypt({name:'AES-GCM',iv}, key, enc.encode(JSON.stringify(obj)));
  return {iv:bufToBase64(iv),ct:bufToBase64(ct)};
}
async function decryptData(key,ivB64,ctB64){
  const iv = base64ToBuf(ivB64);
  const ct = base64ToBuf(ctB64);
  const plain = await crypto.subtle.decrypt({name:'AES-GCM',iv}, key, ct);
  return JSON.parse(new TextDecoder().decode(plain));
}

// ---------------- STORAGE ----------------
const SALT_KEY='vault_salt';
const DATA_KEY='vault_data';
const HINT_KEY='vault_hint';
let inactivityTimer=null;
function saveSalt(salt){localStorage.setItem(SALT_KEY,bufToBase64(salt));}
function loadSalt(){const s=localStorage.getItem(SALT_KEY);return s?base64ToBuf(s):null;}
function uid(){return Math.random().toString(36).slice(2,10);}

// ---------------- PASSWORD VALIDATION ----------------
function validateMasterPassword(pw){
  const regex=/^(?=.*[a-z])(?=.*[A-Z])(?=.*\\d)(?=.*[!@#$%^&*()_+]).{8,}$/;
  return regex.test(pw);
}

// ---------------- APP STATE ----------------
let masterKey=null;
let vault={items:[]};
const app=document.getElementById('vault-interface');

if(!loadSalt()) renderSetPassword(); else renderUnlock();

// ---------------- RESET ----------------
function resetVault(){
  if(confirm('‚ö†Ô∏è Erase vault & reset password? This cannot be undone.')){
    localStorage.clear();
    alert('Vault reset! Please set a new password.');
    renderSetPassword();
  }
}

// ---------------- SET PASSWORD ----------------
function renderSetPassword(){
  app.innerHTML=`
    <p>Set your master password</p>
    <input type="password" id="mp" placeholder="Master Password" class="p-2 border rounded w-full mt-2" />
    <input type="text" id="hint" placeholder="Password Hint (optional)" class="p-2 border rounded w-full mt-2" />
    <div id="error" class="text-red-600 text-sm mt-2"></div>
    <button id="setBtn" class="bg-indigo-600 text-white p-2 mt-2 rounded w-full">Set Password</button>`;
  document.getElementById('setBtn').onclick=async ()=>{
    const pw=document.getElementById('mp').value.trim();
    const hint=document.getElementById('hint').value.trim();
    if(!validateMasterPassword(pw)){
      document.getElementById('error').innerText='Password must include upper, lower, number, symbol, and 8+ characters.';
      return;
    }
    const salt=crypto.getRandomValues(new Uint8Array(16));
    saveSalt(salt);
    if(hint) localStorage.setItem(HINT_KEY, hint);
    masterKey=await deriveKey(pw,salt);
    vault={items:[]};
    await saveVault(vault,masterKey);
    alert('Password set successfully! Please unlock.');
    renderUnlock();
  };
}

// ---------------- UNLOCK ----------------
function renderUnlock(){
  const hint=localStorage.getItem(HINT_KEY)||'';
  app.innerHTML=`
    <p>Enter Master Password</p>
    <div class="relative">
      <input type="password" id="mp" placeholder="Master Password" class="p-2 border rounded w-full mt-2" />
      ${hint?`<span title="Hint: ${hint}" class="absolute right-3 top-4 text-gray-500 cursor-pointer">üí°</span>`:''}
    </div>
    <div id="error" class="text-red-600 text-sm mt-2"></div>
    <button id="loginBtn" class="bg-indigo-600 text-white p-2 mt-2 rounded w-full">Unlock Vault</button>
    <button id="resetBtn" class="bg-red-600 text-white p-2 mt-2 rounded w-full">Reset Vault</button>`;
  document.getElementById('loginBtn').onclick=async ()=>{
    const pw=document.getElementById('mp').value.trim();
    const salt=loadSalt();
    try{
      masterKey=await deriveKey(pw,salt);
      vault=await loadVault(masterKey);
      renderVault();
      await registerMessagingServiceWorker();
      await requestNotificationPermissionAndSaveToken();
      resetInactivityTimer();
    }catch(e){
      document.getElementById('error').innerText='Incorrect password or vault corrupted.';
    }
  };
  document.getElementById('resetBtn').onclick=resetVault;
}

// ---------------- AUTO-LOCK TIMER ----------------
function resetInactivityTimer(){
  clearTimeout(inactivityTimer);
  inactivityTimer=setTimeout(()=>{
    alert('Vault auto-locked due to inactivity.');
    masterKey=null;
    renderUnlock();
  }, 5*60*1000); // 5 minutes
  document.body.onmousemove=document.body.onkeydown=()=>resetInactivityTimer();
}

// ---------------- VAULT ----------------
async function saveVault(obj, key){
  const enc=await encryptData(key,obj);
  localStorage.setItem(DATA_KEY,JSON.stringify(enc));
  try{ await db.collection('vaults').doc('myVault').set(enc);}catch(e){console.error('Firebase sync failed',e);}
}
async function loadVault(key){
  const localEnc=JSON.parse(localStorage.getItem(DATA_KEY)||'null');
  if(localEnc) return await decryptData(key,localEnc.iv,localEnc.ct);
  const doc=await db.collection('vaults').doc('myVault').get();
  if(doc.exists){
    const enc=doc.data();
    return await decryptData(key,enc.iv,enc.ct);
  }
  return {items:[]};
}

function renderVault(){
  app.innerHTML=`
    <div class='flex gap-2 mb-3'>
      <button id='addReminder' class='bg-yellow-600 text-white p-2 rounded'>+ Reminder</button>
      <button id='lock' class='bg-red-600 text-white p-2 rounded'>Lock</button>
    </div>
    <div id='items'></div>`;
  document.getElementById('addReminder').onclick=()=>addItem('reminder');
  document.getElementById('lock').onclick=()=>{masterKey=null;renderUnlock();};
  renderItems();
  scheduleDueReminders();
}

function addItem(type){
  const title=prompt('Title:');
  const content=prompt('Reminder content:');
  const date=prompt('Enter date-time (YYYY-MM-DD HH:mm):');
  vault.items.unshift({id:uid(),type,title,content,date});
  saveVault(vault,masterKey);
  renderItems();
}

function renderItems(){
  const container=document.getElementById('items');
  container.innerHTML='';
  vault.items.forEach(item=>{
    const div=document.createElement('div');
    div.className='p-3 bg-white shadow rounded mb-2';
    div.innerHTML=`<b>${item.title}</b><br>${item.content}<br><i>${item.date}</i>`;
    container.appendChild(div);
  });
}

// ---------------- LOCAL REMINDERS ----------------
function scheduleDueReminders(){
  const now=Date.now();
  vault.items.forEach(item=>{
    if(item.type==='reminder' && item.date){
      const t=new Date(item.date).getTime();
      const delay=t-now;
      if(delay>0 && delay<2147483647){
        setTimeout(()=>new Notification(`Reminder: ${item.title}`,{body:item.content||''}),delay);
      }
    }
  });
}

// ---------------- FCM MESSAGING ----------------
async function registerMessagingServiceWorker(){
  if('serviceWorker' in navigator){
    const reg=await navigator.serviceWorker.register('/firebase-messaging-sw.js');
    messaging.useServiceWorker(reg);
  }
}
async function requestNotificationPermissionAndSaveToken(){
  try{
    const perm=await Notification.requestPermission();
    if(perm!=='granted') return;
    const vapidKey='YOUR_VAPID_PUBLIC_KEY';
    const token=await messaging.getToken({vapidKey});
    if(token){
      await db.collection('fcm_tokens').doc(token).set({
        token,
        createdAt:firebase.firestore.FieldValue.serverTimestamp(),
        platform:navigator.userAgent
      });
      console.log('Token saved',token);
    }
  }catch(e){console.error(e);}
}
messaging.onMessage((payload)=>{
  console.log('Message received',payload);
  new Notification(payload.notification.title,{body:payload.notification.body});
});
</script>
</body>
</html>
