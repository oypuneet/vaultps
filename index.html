<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Secure Vault</title>
<link rel="manifest" href="manifest.json">
<script src="https://cdn.tailwindcss.com"></script>
<script src="https://cdn.jsdelivr.net/npm/crypto-js@4.1.1/crypto-js.min.js"></script>
</head>
<body class="bg-gray-100 min-h-screen flex items-center justify-center p-4">
<div id="app" class="bg-white rounded-2xl shadow-xl p-6 w-full max-w-md">

<h1 class="text-2xl font-bold text-center mb-4">üîê Secure Vault</h1>

<!-- SET PASSWORD -->
<div id="set-password" class="space-y-3">
  <input id="newPassword" type="password" placeholder="Set Master Password"
         class="border rounded w-full p-2">
  <input id="passwordHint" type="text" placeholder="Password Hint (optional)"
         class="border rounded w-full p-2">
  <div id="setError" class="text-red-600 text-sm"></div>
  <button id="savePassword" class="bg-blue-600 text-white w-full p-2 rounded">Set Password</button>
</div>

<!-- UNLOCK -->
<div id="unlock" class="space-y-3 hidden">
  <div class="relative">
    <input id="masterPassword" type="password" placeholder="Enter Master Password"
           class="border rounded w-full p-2">
    <span id="hintIcon" title="" class="absolute right-3 top-3 text-gray-500 cursor-pointer hidden">üí°</span>
  </div>
  <div id="unlockError" class="text-red-600 text-sm"></div>
  <button id="unlockBtn" class="bg-green-600 text-white w-full p-2 rounded">Unlock</button>
</div>

<!-- VAULT -->
<div id="vault" class="hidden">
  <div class="flex justify-between items-center mb-3">
    <h2 class="text-xl font-semibold">My Vault</h2>
    <button id="lockBtn" class="text-red-500">Lock</button>
  </div>
  <textarea id="vaultText" class="border w-full p-2 rounded h-40" placeholder="Write notes / passwords‚Ä¶"></textarea>
  <button id="saveVault" class="bg-blue-600 text-white w-full p-2 rounded mt-3">Save Vault</button>

  <h3 class="text-lg font-semibold mt-5 mb-2">Reminders</h3>
  <input id="reminderText" type="text" placeholder="Reminder text" class="border rounded w-full p-2 mb-2">
  <input id="reminderTime" type="datetime-local" class="border rounded w-full p-2 mb-2">
  <button id="addReminder" class="bg-indigo-600 text-white w-full p-2 rounded">Add Reminder</button>

  <ul id="reminderList" class="mt-3 text-sm space-y-1"></ul>
</div>
</div>

<script>
/* ---------- Utilities ---------- */
function getVaultKey(pass){ return CryptoJS.SHA256(pass).toString(); }
function encrypt(text,key){ return CryptoJS.AES.encrypt(text,key).toString(); }
function decrypt(cipher,key){ try{ return CryptoJS.AES.decrypt(cipher,key).toString(CryptoJS.enc.Utf8) }catch(e){ return ""; } }

/* ---------- DOM ---------- */
const setDiv = document.getElementById('set-password');
const unlockDiv = document.getElementById('unlock');
const vaultDiv = document.getElementById('vault');

const newPwdInput = document.getElementById('newPassword');
const hintInput = document.getElementById('passwordHint');
const masterPwdInput = document.getElementById('masterPassword');
const hintIcon = document.getElementById('hintIcon');
const vaultText = document.getElementById('vaultText');
const reminderList = document.getElementById('reminderList');

const setError = document.getElementById('setError');
const unlockError = document.getElementById('unlockError');

/* ---------- Load state ---------- */
if(localStorage.getItem('vault_key')){
  setDiv.classList.add('hidden');
  unlockDiv.classList.remove('hidden');
  const hint = localStorage.getItem('vault_hint');
  if(hint){ hintIcon.title = hint; hintIcon.classList.remove('hidden'); }
}

/* ---------- Auto-lock ---------- */
let inactivityTimer=null;
function resetTimer(){
  clearTimeout(inactivityTimer);
  inactivityTimer=setTimeout(()=>{ 
    alert('Vault auto-locked due to inactivity.');
    vaultDiv.classList.add('hidden');
    unlockDiv.classList.remove('hidden');
    vaultText.value=""; 
    localStorage.removeItem('session_key'); 
  }, 5*60*1000);
}
document.body.onmousemove=document.body.onkeydown=resetTimer;

/* ---------- Password Setup ---------- */
document.getElementById('savePassword').onclick = () => {
  const pwd = newPwdInput.value.trim();
  if(!/^(?=.*[A-Z])(?=.*[a-z])(?=.*\d)(?=.*[!@#$%^&*()_+]).{8,}$/.test(pwd)){
    setError.textContent = 'Password must be 8+ chars, include upper/lower/number/symbol.';
    return;
  }
  localStorage.setItem('vault_key', getVaultKey(pwd));
  localStorage.setItem('vault_hint', hintInput.value.trim());
  alert('Password set! Now unlock to start.');
  setDiv.classList.add('hidden');
  unlockDiv.classList.remove('hidden');
  if(hintInput.value.trim()){ hintIcon.title = hintInput.value.trim(); hintIcon.classList.remove('hidden'); }
};

/* ---------- Unlock ---------- */
document.getElementById('unlockBtn').onclick = () => {
  const pwd = masterPwdInput.value.trim();
  const key = getVaultKey(pwd);
  if(key !== localStorage.getItem('vault_key')){
    unlockError.textContent='Incorrect password';
    return;
  }
  const enc = localStorage.getItem('vault_data');
  if(enc) vaultText.value = decrypt(enc,key) || "";
  localStorage.setItem('session_key', key);
  unlockDiv.classList.add('hidden');
  vaultDiv.classList.remove('hidden');
  resetTimer();
  loadReminders();
};

/* ---------- Save Vault ---------- */
document.getElementById('saveVault').onclick = () => {
  const key = localStorage.getItem('session_key');
  if(!key) return;
  localStorage.setItem('vault_data', encrypt(vaultText.value,key));
  alert('Saved securely offline.');
};

/* ---------- Lock ---------- */
document.getElementById('lockBtn').onclick = () => {
  vaultDiv.classList.add('hidden');
  unlockDiv.classList.remove('hidden');
  vaultText.value="";
  localStorage.removeItem('session_key');
};

/* ---------- Reminders ---------- */
function scheduleReminder(text,time){
  const delay = time - Date.now();
  if(delay<=0) return;
  setTimeout(()=>{ new Notification("Vault Reminder",{body:text}); }, delay);
}

function loadReminders(){
  const reminders = JSON.parse(localStorage.getItem('vault_reminders')||"[]");
  reminderList.innerHTML="";
  reminders.forEach(r=>{
    const li = document.createElement('li');
    li.textContent = `‚è∞ ${new Date(r.time).toLocaleString()} ‚Äì ${r.text}`;
    reminderList.appendChild(li);
    scheduleReminder(r.text,r.time);
  });
}

document.getElementById('addReminder').onclick = () => {
  const text = document.getElementById('reminderText').value.trim();
  const timeStr = document.getElementById('reminderTime').value;
  if(!text||!timeStr){ alert('Fill both fields'); return; }
  const t = new Date(timeStr).getTime();
  if(isNaN(t)){ alert('Invalid time'); return; }
  const reminders = JSON.parse(localStorage.getItem('vault_reminders')||"[]");
  reminders.push({text,time:t});
  localStorage.setItem('vault_reminders',JSON.stringify(reminders));
  document.getElementById('reminderText').value="";
  document.getElementById('reminderTime').value="";
  loadReminders();
};

/* ---------- Notifications ---------- */
(async()=>{
  if(Notification && Notification.permission !== 'granted'){
    await Notification.requestPermission();
  }
})();
</script>
</body>
</html>
